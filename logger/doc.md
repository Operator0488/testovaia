## Компонент структурного логирования

### Общее описание

Структурный логгер реализован в виде пакета https://git.vepay.dev/bakend-platform/logger и является исключением с точки зрения практики внедрения зависимостей. Такой подход выбран для удобства использования без необходимости повсеместного прокидывания логгера в качестве зависимости.

Не смотря на глобальную повсеместную доступность лога, он может быть замокирован в рамках тестов. Но, опять же, глобально для выполняемого теста. 

Представлен интерфейсом:

```go
type Logger interface {
    Level() Level
    With(ctx context.Context, fields ...Field) context.Context
    Debug(ctx context.Context, msg string, fields ...Field) Logger
    Info(ctx context.Context, msg string, fields ...Field) Logger
    Warn(ctx context.Context, msg string, fields ...Field) Logger
    Error(ctx context.Context, msg string, fields ...Field) Logger
    Fatal(ctx context.Context, msg string, fields ...Field)
}
```

И набором глобальных функций:

```go
func With(ctx context.Context, fields ...Field) context.Context
```
Добавляет постоянную переменную(или переменные) к выводу лога в пределах использования полученного в результате вызова функции контекста. Постоянные переменные не будут добавляться к выводу лога, если использовать отличный от полученного в результате вызова функции контекст

```go
func Debug(ctx context.Context, msg string, fields ...Field) Logger
```
Добаялет сообщение в лог с уровнем Debug. Сообщение будет включать в себя все добавленные в результате With переменные, TraceId, а также переменные переданные непосредствено при вызове метода

```go
func Info(ctx context.Context, msg string, fields ...Field) Logger
```
Добаялет сообщение в лог с уровнем Info. Сообщение будет включать в себя все добавленные в результате With переменные, TraceId, а также переменные переданные непосредствено при вызове метода

```go
func Warn(ctx context.Context, msg string, fields ...Field) Logger
```
Добаялет сообщение в лог с уровнем Warn. Сообщение будет включать в себя все добавленные в результате With переменные, TraceId, а также переменные переданные непосредствено при вызове метода

```go
func Error(ctx context.Context, msg string, fields ...Field) Logger
```
Добаялет сообщение в лог с уровнем Error. Сообщение будет включать в себя все добавленные в результате With переменные, StackTrace, TraceId, а также переменные переданные непосредствено при вызове метода. 

```go
func Fatal(ctx context.Context, msg string, fields ...Field)
```
Добаялет сообщение в лог с уровнем Fatal и завершает работу приложения. Сообщение будет включать в себя все добавленные в результате With переменные, TraceId, а также переменные переданные непосредствено при вызове метода

### Переменные лога

Так как логгер является структурным, каждое сообщение может быть расширено именованными переменными. Наличие таких именованных переменных позволяет более точно выполнять поиск и фильтрацию логов без необходимости применения полнотекстового поиска. 

Добавляемые к логу переменные могут быть типизированы. Это необходимо для возможности настройки типизированных индексов на стороне коллекторов логов. И позволяет проводить фильтрацию более быстро.

Для добавления типизированных переменных доступны соответствующие методы для каждого из стандартных типов. Поддерживаются практически все стандартные типы go, а также реализации для Time и Duration. 

Пример создания переменной:
```go
logger.Int("myFieldName", 12345)
```
В качестве типов переменных также доступны реализации с указателем. Сигнатуры таких методов имеют суффикс "p". Может быть полезно для безопасного добавления переменных к логу без проверки указателей на nil.
```go
logger.Intp("myFieldName", myIntPtr)
```
Отдельного внимания заслуживает метод logger.Any(). Метод автоматически определяет наиболее подходящий тип переменной. Не смотря на удобство, использование метода требует осторожности, так как под капотом присутствует рефлексия, что может приводить к снижению производительности.  

### Примеры использования

#### Добавление полей к выводу лога

```go
import "https://git.vepay.dev/bakend-platform/logger"

func myFunc(ctx context.Contex, req RequestModel) {
    // Вывод лога будет включать поле userId типа "строка"
    logger.Info(ctx, "Привет!", logger.String("userId", req.UserId))
	
    // Вывод лога будет включать поля userId и sessionId
    logger.Info(ctx, "Привет ещё раз!",
        logger.String("userId", req.UserId),
        logger.String("sessionId", req.SessionId))
}
```

#### Добавление постоянных полей в лог в пределах контекста
```go
import "https://git.vepay.dev/bakend-platform/logger"

func myFunc(ctx context.Contex, req RequestModel) {
    // Добавляет ко всем дальнейшим выводам лога поле userId
    // Так как поля фактически хранятся в контексте, то результатом 
    // добавления поля к логу будет новый контекст
    ctx = logger.With(ctx, logger.String("userId", req.UserId)
	
    // Вывод лога будет включать поле userId
    logger.Info(ctx, "Привет!")
}
```